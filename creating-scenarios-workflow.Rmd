---
title: "Creating Climate Scenarios Workflow"
author: "Fire Futures"
date: "2023-04-25"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(strex)
library(tidyverse)
library(lubridate)
library(purrr)
```

This Rmarkdown provides step by step instructions for creating climate scenarios and exporting them into RHESSys formatted time series 

#1. Cal-Adapt cleaning steps ... if you have all of the data downloaded from the cal-adapt website
```{r}
source("/capstone/firefutures/data_cleaning/cal_adapt_4models_allscenarios.R")
```

Alternatively, use CalAdaptR API or read in your own file in this format:

******
FORMAT
******

#2 Building runs 

Sourcing all of the functions in the build-runs workflow 
```{r}
# Get list of files in the directory
files <- list.files("./climate-scenarios/find_matches-functions", full.names = TRUE)

# Source all files using lapply
lapply(files, source)
```

A. Accessing unfiltered data frame from 1950-2100:
If you used the data cleaning step above & have multiple files in your global environment in this format: model_rcp#_cell# ("MIROC5_rcp45_2")

```{r}
dat <- find_df(45, "MIROC5", 2) 

head(dat)
```

B. Create your table to designate desired percentile filters for each run. Make sure the length of the list is the desired number of runs you'd like. 

If you would like to sample from all available runs, input one climate variable and designate your lower and upper percentiles to be 0 & 1
(? fix the function to allow null value ?) 

Run & Notes = Input for metadeta file

```{r, Example Percentile Table}
#source (REMEMBER TO SOURCE)

criteria_list <- list(
  data.frame(
    run = 'year 1 season 1',
    notes = 'Likely Scenario',
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.1, .1, .1),
    upper = c(.99, .99, .99)
  ),
  data.frame(
    run = 'year 1 season 2',
    notes = 'Average-Above Average Dry',
    variable = c('min_temp'),
    lower = c(.55),
    upper = c(.85)
  ),
  data.frame(
    run = 'year 2 season 2',
    notes = 'Average: wind, precip, max_temp',
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.25, .25, .65),
    upper = c(.75, .75, .75)
  ),
  data.frame(
    run = 'year 3 season 1',
    notes = 'No specification',
    variable = c('wind'),
    lower = (0),
    upper = (1) #ALL RUNS IN SAMPLE WINDOW 
  )
)

criteria_list <- repeat_segment(criteria_list, c(1,2,3,4), 4)
```

Finding Runs Based on Years: Here we will use the build_runs function and specify all of the information we want...
Instead of specifying rcp, gcm and sample cell you can specify a data frame (our_gcm = dat)

Two examples: 
one specifying gcm, rcp, and sample cell to find associated data
the other specifying a data frame already in global environment/in correct format 

```{r finding runs that match climate percentiles}
#If you used our cleaning process and/or your files are named in this convention: Model_rcp45_#cell ex. MIROC5_rcp45_2
ui_rcp <- 45 #rcp 45 or 85
ui_gcm <- 'MIROC5' #MIROC5, CNRM_CM5, CanESM2, HadGEM2ES 
ui_sample_cell <- 2 #Any sample cell in your environment 

#Otherwise a specify data frame in ui_base_data
ui_base_data <- dat

ui_segment_type <- 'season' #year or season
#season is defined in find_matches.R currently: wet is months 11-4 and dry 5-10

ui_start_date <- '10/07/2000' #MM/DD/YYYY

ui_climate_criteria_table <- criteria_list #Defined above 

ui_sample_window <- 20 #Even number: split above and below start date 

run_samples <<-
  find_matches(
    rcp = ui_rcp,
    #45 or 85
    gcm = ui_gcm,
    sample_cell = ui_sample_cell,
    start_date = ui_start_date,
    sample_window = ui_sample_window,
    climate_criteria_table = ui_climate_criteria_table,
    segment_type = ui_segment_type,
  )

head(run_samples)
```

Randomly Select
Takes the above list of matching options and randomly selects one of each
```{r}
source("/capstone/firefutures/climate-scenarios/randomly_select.R")
randomly_select(run_samples = run_samples)
```


Build the scenarios for each grid cell, convert to time series
```{r}
source("/capstone/firefutures/climate-scenarios/get_all_grid_cells_function.R")

ui_grid_cells <- c(1,2) # Select all grid cells
get_all_grid_cells_function(ui_grid_cells)
```



