---
title: "Creating Climate Scenarios Workflow"
author: "Fire Futures"
date: "2023-04-25"
output: html_document
---

This Rmarkdown provides step by step instructions for creating climate scenarios and exporting them into RHESSys formatted time series 

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(strex)
library(tidyverse)
library(lubridate)
library(purrr)
library(here)
library(sf)
library(leaflet)
library(caladaptr)  # remotes::install_github("ucanr-igis/caladaptr")
library(ggplot2)
library(ggrepel)
library(dplyr)
```

```{r}
# specify your RCP, GCM, and grid cells
ui_grid_cells <- c(23696, 46896, 46898) # please see map, above, and select grid cells of interest in the format c(23696, 46896)
ui_rcp <- 85 # options: 45, 85
ui_gcm <- 'CanESM2' # options: 'HadGEM2-ES', 'CNRM-CM5', 'CanESM2', 'MIROC5'
```

Sourcing all of the functions needed to build scenarios & importing example data. All functions are in the build_runs-functions folder of the climate-scenarios repository
```{r}
r_files <- list.files("build_functions", pattern = "\\.R$", full.names = TRUE)

for (file in r_files) {
  source(file)
}
```

Use Cal Adapt API
```{r}
# run the Cal Adapt Map to find your grid cells of interest
caladapt_map()

# specify if you will use the cal adapt data api
ui_caladapt_ind = 'Y' # mark as Y if using cal adapt data through this api. if uploading your own data, no need to run this line.

# run the functions
find_grid_cell_centroid() # creates the dataframe with the above user inputs that the get_all_grid_cell_data() function will use to grab data for

centroids_of_interest %>% pmap(get_all_grid_cell_data) # grabs data for all grid cells 
```

OR Input Your Own Data
Just Make Sure You Follow This Structure:
- naming conventions: for each grid cell, name each as "grid_cell_X"
- columns:
  - date (class: date YYYY-MM-DD)
  - X
  - Y
  - Z
  - water_year
  - season
```{r}

```

B. Create your table to designate desired percentile filters for each run. Make sure the length of the list is the desired number of runs you'd like. 

-If you would like to sample from all available runs, input one climate variable and designate your lower and upper percentiles to be 0 & 1

-Run & Notes = Input for metadeta file

-repeat_segment allows you to repeat any of the climate criteria (or a few in order) your desired amount of times

```{r, Example Percentile Table}
criteria_list <- list(
  data.frame(
    segment_spec_id = '1', # may need for metadata clarity?
    notes = 'Likely segment',
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.1, .1, .1),
    upper = c(.99, .99, .99)
  ),
  data.frame(
    segment_spec_id = '2',
    notes = 'Average-Above Average Dry',
    variable = c('min_temp'),
    lower = c(.0),
    upper = c(1)
  ),
  data.frame(
    segment_spec_id = '3',
    notes = 'Average: wind, precip, max_temp',
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(0, 0, 0),
    upper = c(1, 1, 1)
  ),
  data.frame(
    segment_spec_id = '4',
    notes = 'No specification',
    variable = c('wind'),
    lower = (0),
    upper = (1) #ALL RUNS IN SAMPLE WINDOW 
  )
)

criteria_list <- repeat_segments(criteria_list, c(1,2,3,4), 4) #repeat 1-4 four times 
```

C. Finding Runs Based on Years: Here we will use the mind_matches function and specify all of the information we want...

Instead of specifying rcp, gcm and sample cell you can specify a data frame (base_data = dat)

Two examples: 
one specifying gcm, rcp, and sample cell to find associated data

the other specifying a data frame already in global environment/in correct format 

```{r finding runs that match climate percentiles}
# ui_sample_cell <- 'grid_cell_23696' # pick the grid cell that you will base all your filtering off of. use '' for metadata purposes


ui_sample_cell <- grid_cell_23696 # pick the grid cell that you will base all your filtering off of. use '' for metadata purposes


ui_segment_type <- 'season' #year or season
#season is defined in find_matches.R currently: wet is months 11-4 and dry 5-10

ui_start_date <- '2000/07/01' # YYYY/MM/DD

ui_climate_criteria_table <- criteria_list #Defined above 

ui_sample_window <- 20 #Even number: split above and below start date 

run_samples <<-
  find_matches(
    # base_data = get(ui_sample_cell, envir = globalenv()),
    base_data = ui_sample_cell,
    start_date = ui_start_date, 
    sample_window = ui_sample_window,
    climate_criteria_table = ui_climate_criteria_table, 
    segment_type = ui_segment_type,
  )

head(run_samples)

# Count the number of elements in each list index
number_matches <- lapply(run_samples, function(x) length(x))

# Create a dataframe with the index and the count of years/seasons
number_matches <- data.frame(Count = unlist(number_matches))

# Print the results
print(number_matches)
```

Randomly Select
Takes the above list of matching options and randomly selects one of each
```{r}
randomly_select(run_samples = run_samples) #This will only work if all segments have something to sample from
```


Build the scenarios for each grid cell, convert to time series
```{r}
find_all_grid_cells()
get_all_grid_cells(df_names = ui_df_names)
```

Get Metadata
```{r}
get_metadata() 
```




