---
title: "Creating Climate Scenarios Workflow"
author: "Fire Futures"
date: "2023-04-25"
output: html_document
---
```{r}
knitr::opts_chunk$set(echo = TRUE)
library(strex)
library(tidyverse)
library(lubridate)
library(purrr)
library(here)
library(sf)
library(leaflet)
library(caladaptr)
library(ggplot2)
library(ggrepel)
library(dplyr)

r_files <- list.files("build_functions", pattern = "\\.R$", full.names = TRUE)

for (file in r_files) {
  source(file)
}
```

This Rmarkdown provides step by step instructions for creating climate scenarios and exporting them into RHESSys formatted time series 

Sourcing all of the functions needed to build scenarios & importing example data. All functions are in the build_runs-functions folder of the climate-scenarios repository

Use Cal Adapt API
```{r}
# run the Cal Adapt Map to find your grid cells of interest
caladapt_map()

# specify your RCP, GCM, and grid cells
ui_grid_cells <- c(23696, 46896, 46898) # please see map, above, and select grid cells of interest in the format c(23696, 46896)
ui_rcp <- 85 # options: 45, 85
ui_gcm <- 'MIROC5' # options: 'HadGEM2-ES', 'CNRM-CM5', 'CanESM2', 'MIROC5'

# run the functions
find_grid_cell_centroid() # creates the dataframe with the above user inputs that the get_all_grid_cell_data() function will use to grab data for
centroids_of_interest %>% pmap(get_all_grid_cell_data) # grabs data for all grid cells 
```

OR Input Your Own Data
Just Make Sure You Follow This Structure:
- naming conventions: for each grid cell, name each as "grid_cell_X"
- columns:
  - date (class: date YMD)
  - X
  - Y
  - Z
  - water_year
  - season
```{r}
grid_cell_1 <- read.csv(url("https://raw.githubusercontent.com/fire-futures/climate-scenarios/main/MIROC5_rcp45_1"))

grid_cell_2 <- read.csv(url("https://raw.githubusercontent.com/fire-futures/climate-scenarios/main/MIROC_rcp45_2")) 
```

B. Create your table to designate desired percentile filters for each run. Make sure the length of the list is the desired number of runs you'd like. 

-If you would like to sample from all available runs, input one climate variable and designate your lower and upper percentiles to be 0 & 1

-Run & Notes = Input for metadeta file

-repeat_segment allows you to repeat any of the climate criteria (or a few in order) your desired amount of times

```{r, Example Percentile Table}
criteria_list <- list(
  data.frame(
    run = 'year 1 season 1',
    notes = 'Likely segment', # vc modified
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.1, .1, .1),
    upper = c(.99, .99, .99)
  ),
  data.frame(
    run = 'year 1 season 2',
    notes = 'Average-Above Average Dry',
    variable = c('min_temp'),
    lower = c(.55),
    upper = c(.85)
  ),
  data.frame(
    run = 'year 2 season 2',
    notes = 'Average: wind, precip, max_temp',
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.25, .25, .15),
    upper = c(.75, .75, .75)
  ),
  data.frame(
    run = 'year 3 season 1',
    notes = 'No specification',
    variable = c('wind'),
    lower = (0),
    upper = (1) #ALL RUNS IN SAMPLE WINDOW 
  )
)

criteria_list <- repeat_segments(criteria_list, c(1,2,3,4), 4) #repeat 1-4 four times 
```

C. Finding Runs Based on Years: Here we will use the mind_matches function and specify all of the information we want...

Instead of specifying rcp, gcm and sample cell you can specify a data frame (base_data = dat)

Two examples: 
one specifying gcm, rcp, and sample cell to find associated data

the other specifying a data frame already in global environment/in correct format 

```{r finding runs that match climate percentiles}
ui_sample_cell <- grid_cell_23696 # Any sample cell in your environment 

ui_segment_type <- 'season' #year or season
#season is defined in find_matches.R currently: wet is months 11-4 and dry 5-10

ui_start_date <- '10/07/2000' #MM/DD/YYYY

ui_climate_criteria_table <- criteria_list #Defined above 

ui_sample_window <- 20 #Even number: split above and below start date 

run_samples <<-
  find_matches(
    base_data = ui_sample_cell,
    start_date = ui_start_date, 
    sample_window = ui_sample_window,
    climate_criteria_table = ui_climate_criteria_table, 
    segment_type = ui_segment_type,
  )

head(run_samples)
```

Randomly Select
Takes the above list of matching options and randomly selects one of each
```{r}
randomly_select(run_samples = run_samples) #This will only work if all segments have something to sample from
```


Build the scenarios for each grid cell, convert to time series
```{r}
get_all_grid_cells(all_grid_cells = ui_grid_cells)
```

Get Metadata
```{r}
# not ready yet but will: 

# output, for each segment:
  # lower percentile for climate variable
  # upper percentile for climate variable
  # notes
  # gcm
  # rcp
  # run type (season or year)
  # dry season definition
  # wet season defintion
  # scenario start date
  # scenario duration
  # sampling window
  # sample cell
  # all cells
  # available resamples
  # desired resamples
  # historical extremes included (Y/N)
  # calibration included (Y/N)
  # probability 

# and download itself in the root folder of the data download
```

