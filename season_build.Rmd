---
title: "Building Runs"
author: "Mallory Giesie"
date: "2023-04-23"
output: html_document
---

```{r}
source("/capstone/firefutures/data_cleaning/packages.R")
source("/capstone/firefutures/data_cleaning/cal_adapt_4models_allscenarios.R")
```

1. find df
This is the first step in the process of building a run where we get our starting dataframe
```{r}
# Define function to extract data from a particular GCM and RCP scenario for a specific sample cell
find_df <- function(rcp, gcm, sample_cell) {
  
  # Define the valid GCM options
  valid_gcms <- c("MIROC5", "HadGEM2ES", "CanESM2", "CNRM_CM5")
  
  # Check if input gcm is valid. If not, return an error message.
  if (!gcm %in% valid_gcms) {
    stop("Invalid value for gcm. Allowed options are: ", paste(valid_gcms, collapse = ", "))
  }
  
  # Ensure that input rcp is numeric
  rcp <- as.numeric(rcp)
  
  # Check if input rcp is valid (either 45 or 85). If not, return an error message.
  if (!rcp %in% c(45, 85)) {
    stop("Invalid value for rcp. Only 45 or 85 are allowed.")
  }
  
  # Construct the name of the data frame to extract, based on the input GCM and RCP values
  df_name <- paste(gcm, paste0("rcp", rcp), sep = "_")
  
  # Extract the data frame from the global environment, using the constructed name
  df <- get(df_name, envir = globalenv())
  
  # Get the names of the columns in the data frame that correspond to the specified sample cell
  var_names <- grep(paste0("_", sample_cell, "$"), names(df), value = TRUE)
  
  # Select the time column and the columns corresponding to the specified sample cell,
  # and rename the columns to remove the sample cell suffix
  combined_df <- select(df, time, one_of(var_names)) %>%
    rename_all( ~ gsub(paste0("_", sample_cell, "$"), "", .))
  
  # Return the resulting data frame
  return(combined_df)
}

# Example usage of the function
find_df_result <- find_df(45, "MIROC5", 2) 
```

2. filter to correct dates
```{r}
sample_window <- function(start_date, sample_window, df) {
  start_date <- as.Date(start_date, format = "%m/%d/%Y") # Convert start_date to date format
  start <- (start_date - years(sample_window)) # Calculate the first year in the sampling window
  end <- (start_date + years(sample_window)) # Calculate the last year in the sampling window
  
  # Check if sample_window argument is not NULL
  if (!is.null(sample_window)) {
    # Filter the data frame based on the start and end dates
    df <- df %>% filter(time >= start & time <= end)
  } else {
    df <- df
    # If sample_window is NULL, issue a warning and return the entire data frame
    warning("sample_window argument is NULL. Specify sampling window, or else we'll pull from 1950-2100.")
  }
}

#sample_window_example <- sample_window('04/07/2023', 10, df_example)
sample_window_result <- sample_window('04/07/2023', 10, find_df_result)
```


```{r}
#creating a list for practice below
climate_vars_list <- list(
  data.frame(
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.50, .50, .50),
    upper = c(.99, .99, .99)
  ),
  data.frame(
    variable = c('min_temp'),
    lower = c(.55),
    upper = c(.85)
  ),
  data.frame(
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.2, .2, .6),
    upper = c(.80, .80, .80)
  ),
  data.frame(
    variable = c('wind', 'precip', 'max_temp'),
    lower = c(.25, .25, .65),
    upper = c(.75, .75, .75)
  ),
  data.frame(
    variable = c('wind'),
    lower = (.8),
    upper = (.9)
  )
)
```

3. add season to our df 
```{r}
add_season <- function(data) {

data <- data %>% mutate(season = ifelse(lubridate::month(time) %in%  c(11, 12, 1, 2, 3, 4), "wet", "dry"))
  
return(data)
}

add_season_result <- add_season(sample_window_result)
```


```{r}
climate_vars <- list(
  variable = c('wind', 'precip', 'max_temp'),
  lower = c(0.1, 0.1, 0.5),
  upper = c(0.9, 0.9, 0.9)
)
```


```{r}
filter_df_season <- function(df, climate_table) {
  season_year_df <-
    df %>% group_by(year = lubridate::year(time), season) %>% summarise(
      wind = mean(wind),
      max_temp = mean(max_temp),
      min_temp = mean(min_temp),
      precip = sum(precip),
      
      min_humidity = mean(min_humidity)
    )
  
  for (i in 1:length(climate_table)) {
  
  climate_var <- climate_table[[1]][i, "variable"]
  lower <- climate_table[[1]][i, "lower"] 
  upper <- climate_table[[1]][i, "upper"]
    
    lower_perc <-
      quantile(season_year_df[[climate_var]], lower, na.rm = TRUE)
    upper_perc <-
      quantile(season_year_df[[climate_var]], upper, na.rm = TRUE)
    
    season_year_df <-
      season_year_df %>% filter(
        !is.na(!!sym(climate_var)),
        !!sym(climate_var) >= lower_perc,
        !!sym(climate_var) <= upper_perc
      )
  }
  
  season_year <- paste(season_year_df$year)
  return(season_year)
}

season_year_df_result <- filter_df_season(add_season_result, climate_vars_list[1])
```


```{r}
filter_season <- function(rcp,
                        gcm,
                        sample_cell,
                        run_type,
                        start_date,
                        duration,
                        climate_table,
                        sample_window) {
  
find_df <- find_df(rcp, gcm, sample_cell)

our_gcm <- find_df %>% add_season()

df_list <- list()

  for (i in 1:length(climate_vars_list)) {
  start_date <- as.Date(start_date, format = "%m/%d/%Y")
    
  sample_window_df <- sample_window(start_date, duration, our_gcm)
   #%>% dplyr::filter(season == season[i])
  
  # Call filter_df at index i of the climate variables list
  run_samples <- filter_df_season(sample_window_df, climate_table[i])

  # Appends the output to the df_list
  df_list[[i]] <- run_samples
  print(df_list)
  start_date <- start_date + years(1) # Add one year to start_date
}
  
#Returns the list of filtered years for each data frame that can be put into the stitches function
  return(df_list)
}

filter_season_result <- filter_season(
    rcp = 45,
    gcm = "MIROC5",
    sample_cell = 2,
    start_date = '10/07/2023',
    sample_window = 10,
    duration = 10,
    climate_table = climate_vars_list
  ) 
```

